name: Build and Upload Resource Packs

on:
  push:
    tags:
      - 'v*.*.*'

jobs:
  build-and-upload:
    runs-on: ubuntu-latest
    permissions:
      contents: write  # Releaseã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã«å¿…è¦

    steps:
      - name: ğŸ“¦ Checkout code
        uses: actions/checkout@v4

      - name: ğŸ³ Set up Docker
        uses: docker/setup-buildx-action@v3

      - name: ğŸ”§ Install make, jq, gh CLI
        run: |
          sudo apt-get update
          sudo apt-get install -y make jq gh

      - name: ğŸ“¥ Get release asset list
        id: get_assets
        run: |
          tag="${GITHUB_REF##*/}"
          gh release view "$tag" --json assets --jq '.assets[].name' > existing_assets.txt || touch existing_assets.txt
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: ğŸ”„ Loop and pack changed files only
        run: |
          for json in translated/*/*/lang/ja_jp.json; do
            [ -f "$json" ] || continue
            name=$(basename $(dirname $(dirname "$json")))
            ver=$(basename $(dirname $(dirname $(dirname "$json"))))
            zipname="${name}-translate-to-japanese-${ver}.zip"
            zip="build/resourcepacks/$zipname"

            # ãƒ‘ãƒƒã‚¯å¯¾è±¡åˆ¤å®š: zipãŒãªã„ or jsonãŒæ–°ã—ã„
            if grep -Fxq "$zipname" existing_assets.txt; then
              echo "âœ… Already uploaded: $zipname â†’ skipping"
              continue
            fi

            if [ ! -f "$zip" ] || [ "$json" -nt "$zip" ]; then
              echo "ğŸ”¨ Packing $zipname..."
              make pack NAME="$name" VER="$ver"
            else
              echo "â™»ï¸ Up-to-date: skipping $zipname"
            fi
          done

      - name: ğŸš€ Upload new zips to GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          files: build/resourcepacks/*.zip
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}